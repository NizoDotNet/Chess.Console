@using Chess.Main
@using Chess.Pieces
@using Chess.Helpers

<div class="board">
    @for (int rank = 8; rank >= 1; rank--)
    {
        <div class="rank">
            @for (int fileIndex = 1; fileIndex <= 8; fileIndex++)
            {
                var coord = new Coordinate(rank, (File)fileIndex);
                PieceAndCoordinates.TryGetValue(coord, out var piece);

                <div class="square @(IsWhiteSquare(coord) ? "white" : "black")"
                     @onclick="() => OnSquareClick(coord)">
                    @if (piece is not null)
                    {
                        <span>@GetPieceSymbol(piece)</span>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public Dictionary<Coordinate, Piece> PieceAndCoordinates { get; set; } = new();
    [Parameter] public EventCallback<Coordinate> OnSquareSelected { get; set; }

    public void UpdateBoard(Board board)
    {
        PieceAndCoordinates = new(board.PieceAndCoordinates);
        InvokeAsync(StateHasChanged);
    }

    private async Task OnSquareClick(Coordinate coordinate)
    {
        await OnSquareSelected.InvokeAsync(coordinate);
    }

    private static bool IsWhiteSquare(Coordinate c)
        => ((int)c.File + c.Rank) % 2 != 0;

    private static string GetPieceSymbol(Piece piece)
        => piece.Type switch
        {
            PieceType.King => piece.Color == Color.White ? "♔" : "♚",
            PieceType.Queen => piece.Color == Color.White ? "♕" : "♛",
            PieceType.Rook => piece.Color == Color.White ? "♖" : "♜",
            PieceType.Bishop => piece.Color == Color.White ? "♗" : "♝",
            PieceType.Knight => piece.Color == Color.White ? "♘" : "♞",
            PieceType.Pawn => piece.Color == Color.White ? "♙" : "♟",
            _ => ""
        };
}
